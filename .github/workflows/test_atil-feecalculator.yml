on: 
  push:
    branches:
      - "release/rc-*"
jobs:
  build:
    runs-on: ubuntu-latest
    name: Build
    steps:
      - uses: actions/checkout@v3
      - name: Set up .NET Core
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'
          include-prerelease: true
      - name: Install dependencies
        run: dotnet restore .
      - name: Build
        run: dotnet publish ./src/ATIL.FeeCalculator.csproj --configuration Release --no-restore -o publish
      - name: checkout octopus
        uses: OctopusDeploy/install-octopus-cli-action@v3.1.3
      - name: Create zip package  
        uses: OctopusDeploy/create-zip-package-action@v3
        with:
          base_path: infrastructure
          output_folder: ./infra
          package_id: atil_feecalculator-infrastructure
          version: "rc-1.0.${{github.run_number}}"
          files: |
            **/*
      - name: Create API zip
        uses: OctopusDeploy/create-zip-package-action@v3
        with:
          package_id: atil_feecalculator
          version: "rc-1.0.${{github.run_number}}"
          base_path: publish
          output_folder: ./out
          files: |
            **/*
      - name: Push packages  
        uses: OctopusDeploy/push-package-action@v3
        with:
          server: ${{ secrets.OCTOPUS_SERVER }}
          api_key: ${{ secrets.OCTOPUS_APIKEY }}
          space: 'Default'
          packages: |
            infra/atil_feecalculator-infrastructure.rc-1.0.${{github.run_number}}.zip
            out/atil_feecalculator.rc-1.0.${{github.run_number}}.zip
      - name: Create release  
        uses: OctopusDeploy/create-release-action@v3
        with:
          server: ${{ secrets.OCTOPUS_SERVER }}
          api_key: ${{ secrets.OCTOPUS_APIKEY }}
          space: 'Default'
          project: "ATIL - Fee Calculator API"
          release_number: "rc-1.0.${{github.run_number}}"
          channel: Test